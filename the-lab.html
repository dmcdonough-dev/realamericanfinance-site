<!DOCTYPE html>
<html lang="en" class="dark scroll-smooth">
<!-- ... entire <head> and HTML structure up to the end of footer remains EXACTLY the same as my previous response ... -->

    <script>
        let myChart;
        let isWarMode = false;
        let p3Cache = [];
        const CURRENT_VERSION = 'raf_siege_v12'; // bumped for new save format

        function initChart() {
            const ctx = document.getElementById('budgetChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: { 
                    labels: ['Wealth', 'Needs', 'Debt Min', 'Wants+Infra', 'Remaining'],
                    datasets: [{ 
                        data: [0,0,0,0,100], 
                        backgroundColor: ['#B22234', '#FFFFFF', '#DC143C88', '#4b556388', '#11243F'],
                        hoverBackgroundColor: ['#DC143C', '#FFFFFF', '#FF0000', '#6b7280', '#1e3a5f'], 
                        borderWidth: 0 
                    }]
                },
                options: { 
                    cutout: '85%', 
                    plugins: { 
                        legend: { display: false }, 
                        tooltip: {
                            callbacks: { label: ctx => ctx.label + ': $' + ctx.parsed.toLocaleString() }
                        }
                    }
                }
            });

            clearAllInputs();
            loadProfile();
            document.getElementById('paycheck').focus();
        }

        function clearAllInputs() {
            document.getElementById('paycheck').value = '';
            document.getElementById('freq').value = '2';
            document.getElementById('debt-body').innerHTML = `<tr class="border-b border-white/5">
                <td class="py-4 px-2"><input type="text" placeholder="e.g. Visa" class="bg-transparent w-full outline-none text-white text-xs uppercase"></td>
                <td class="py-4 px-2"><input type="number" oninput="calculateAll()" class="debt-min-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                <td class="py-4 px-2"><input type="number" oninput="calculateAll()" class="debt-balance-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                <td class="py-4 px-2"><input type="number" step="0.1" oninput="calculateAll()" class="debt-rate-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                <td class="text-right relative"><button onclick="removeRow(this)" class="hover:text-crimson transition text-lg">×</button>
                    <span class="debt-alert hidden absolute right-8 top-1/2 -translate-y-1/2 high-interest-alert uppercase">HIGH ALERT</span>
                </td>
            </tr>`;
            document.querySelectorAll('.tier-0-input, .tier-1-input, .tier-2-input, .tier-3-input').forEach(i => i.value = '');
        }

        function clearSavedData() {
            if (confirm("Permanently delete all saved data? This cannot be undone.")) {
                localStorage.removeItem(CURRENT_VERSION);
                location.reload();
            }
        }

        function toggleWarMode() {
            isWarMode = !isWarMode;
            const btn = document.getElementById('war-mode-btn');
            const container = document.getElementById('tier-3-container');
            const inputs = document.querySelectorAll('.tier-3-input');
            const surplusEl = document.getElementById('surplus-val');

            if(isWarMode) {
                btn.innerText = "Deactivate War-Mode";
                container.classList.add('war-mode-active', 'war-mode-flash');
                surplusEl.classList.add('breach-alert');
                p3Cache = Array.from(inputs).map(i => i.value || '0');
                inputs.forEach(i => i.value = '0');
            } else {
                btn.innerText = "Initiate War-Mode";
                container.classList.remove('war-mode-active', 'war-mode-flash');
                surplusEl.classList.remove('breach-alert');
                inputs.forEach((i, idx) => i.value = p3Cache[idx] || '0');
            }
            setTimeout(() => container.classList.remove('war-mode-flash'), 2000);
            calculateAll();
        }

        function addDebtRow() {
            const row = document.createElement('tr');
            row.className = "border-b border-white/5";
            row.innerHTML = `<td class="py-4 px-2"><input type="text" placeholder="Liability" class="bg-transparent w-full outline-none text-white text-xs uppercase"></td>
                             <td class="py-4 px-2"><input type="number" oninput="calculateAll()" class="debt-min-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                             <td class="py-4 px-2"><input type="number" oninput="calculateAll()" class="debt-balance-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                             <td class="py-4 px-2"><input type="number" step="0.1" oninput="calculateAll()" class="debt-rate-input bg-transparent w-full outline-none text-white text-xs" placeholder="0"></td>
                             <td class="text-right relative"><button onclick="removeRow(this)" class="hover:text-crimson transition text-lg">×</button>
                                 <span class="debt-alert hidden absolute right-8 top-1/2 -translate-y-1/2 high-interest-alert uppercase">HIGH ALERT</span>
                             </td>`;
            document.getElementById('debt-body').appendChild(row);
        }

        function removeRow(btn) { btn.closest('tr').remove(); calculateAll(); }

        function updateBadge(id, current, target, isHigherBetter = false) {
            const badge = document.getElementById(id);
            badge.innerText = `${Math.round(current)}%`;
            let statusClass = "status-bad";
            if (isHigherBetter) {
                if (current >= target) statusClass = "status-good";
                else if (current >= target * 0.8) statusClass = "status-ok";
            } else {
                if (current <= target) statusClass = "status-good";
                else if (current <= target * 1.2) statusClass = "status-ok";
            }
            badge.className = `perc-badge ${statusClass}`;
        }

        function update503020(needsPerc, wantsPerc, savingsPerc) {
            const needsEl = document.getElementById('rule-needs');
            const wantsEl = document.getElementById('rule-wants');
            const savingsEl = document.getElementById('rule-savings');

            needsEl.textContent = needsPerc.toFixed(0) + '%';
            needsEl.className = needsPerc <= 50 ? 'text-green-400 font-bold' : needsPerc <= 60 ? 'text-yellow-400 font-bold' : 'text-red-400 font-bold';

            wantsEl.textContent = wantsPerc.toFixed(0) + '%';
            wantsEl.className = wantsPerc <= 30 ? 'text-green-400 font-bold' : wantsPerc <= 40 ? 'text-yellow-400 font-bold' : 'text-red-400 font-bold';

            savingsEl.textContent = savingsPerc.toFixed(0) + '%';
            savingsEl.className = savingsPerc >= 20 ? 'text-green-400 font-bold' : savingsPerc >= 10 ? 'text-yellow-400 font-bold' : 'text-red-400 font-bold';
        }

        function calculateAll() {
            const income = (parseFloat(document.getElementById('paycheck').value) || 0) * (parseFloat(document.getElementById('freq').value) || 2);
            let t0 = 0; document.querySelectorAll('.tier-0-input').forEach(i => t0 += (parseFloat(i.value) || 0));
            let dMin = 0; document.querySelectorAll('.debt-min-input').forEach(i => dMin += (parseFloat(i.value) || 0));
            let dTotal = 0; document.querySelectorAll('.debt-balance-input').forEach(i => dTotal += (parseFloat(i.value) || 0));
            let t1 = 0; document.querySelectorAll('.tier-1-input').forEach(i => t1 += (parseFloat(i.value) || 0));
            let t2 = 0; document.querySelectorAll('.tier-2-input').forEach(i => t2 += (parseFloat(i.value) || 0));
            let t3 = 0; document.querySelectorAll('.tier-3-input').forEach(i => t3 += (parseFloat(i.value) || 0));

            const totalOutflow = dMin + t1 + t2 + t3;
            const remaining = income - totalOutflow;
            const warChest = remaining + t0;

            // High-interest alerts
            document.querySelectorAll('#debt-body tr').forEach(row => {
                const rateInput = row.querySelector('.debt-rate-input');
                const alert = row.querySelector('.debt-alert');
                const rate = parseFloat(rateInput.value) || 0;
                if (rate >= 25) alert.classList.remove('hidden');
                else alert.classList.add('hidden');
            });

            const needsPerc = income > 0 ? ((t1 + dMin) / income) * 100 : 0;
            const wantsPerc = income > 0 ? (t3 / income) * 100 : 0;
            const savingsPerc = income > 0 ? (t0 / income) * 100 : 0;

            if (income > 0) {
                updateBadge('badge-t0', savingsPerc, 20, true);
                updateBadge('badge-t1', needsPerc, 50, false);
                updateBadge('badge-t3', wantsPerc, 30, false);
                updateBadge('badge-t2', (t2/income)*100, 15);
            }

            update503020(needsPerc, wantsPerc, savingsPerc);

            let monthsToFreedom = dTotal === 0 ? 0 : remaining <= 0 ? "∞" : Math.ceil(dTotal / (remaining + dMin));
            const countdownEl = document.getElementById('countdown-val');
            countdownEl.classList.remove('text-crimson', 'breach-alert');
            if (monthsToFreedom === 0) {
                countdownEl.innerText = "DEBT FREE";
                countdownEl.classList.add('text-crimson', 'breach-alert');
            } else if (monthsToFreedom === "∞") {
                countdownEl.innerText = "NO SURPLUS";
            } else {
                countdownEl.innerText = `${monthsToFreedom} Months`;
            }

            document.getElementById('center-remaining').innerText = `$${Math.round(remaining).toLocaleString()}`;
            document.getElementById('auto-debt-min').innerText = `$${dMin.toLocaleString()}`;
            document.getElementById('total-debt-val').innerText = `$${dTotal.toLocaleString()}`;
            document.getElementById('surplus-val').innerText = `$${Math.round(warChest).toLocaleString()}`;

            const ironPot = parseFloat(document.querySelector('.tier-0-input')?.value || 0); // first Tier 0 row
            const floor = t1 + dMin;
            const moatTarget = floor * 3;
            const potPerc = moatTarget > 0 ? Math.min(100, (ironPot / moatTarget) * 100) : 0;
            document.getElementById('pot-progress').innerText = `${Math.round(potPerc)}%`;
            document.getElementById('pot-bar').style.width = `${potPerc}%`;

            document.getElementById('order-walls').innerHTML = `<span class="text-crimson">FORTIFY:</span> $${floor.toLocaleString()} monthly floor<br><span class="text-gray-400 text-xs">Survival + debt minimums locked in.</span>`;
            document.getElementById('order-liquidity').innerHTML = `<span class="text-white">BUILD MOAT:</span> Target $${moatTarget.toLocaleString()}<br><span class="text-gray-400 text-xs">3 months of essentials in Iron Pot.</span>`;

            if (dTotal === 0) {
                document.getElementById('order-attack').innerHTML = `<span class="text-crimson breach-alert">SOVEREIGNTY ACHIEVED</span><br><span class="text-gray-300 text-xs">You are debt free. Deploy capital.</span>`;
            } else if (remaining <= 0) {
                document.getElementById('order-attack').innerHTML = `<span class="text-crimson">BREACH DETECTED</span><br><span class="text-gray-400 text-xs">Inflow insufficient. Initiate austerity.</span>`;
            } else {
                document.getElementById('order-attack').innerHTML = `<span class="text-white">ATTACK:</span> $${Math.round(warChest).toLocaleString()} monthly siege<br><span class="text-crimson text-xs">Freedom in ${monthsToFreedom} months.</span>`;
            }

            myChart.data.datasets[0].data = [t0, t1, dMin, t2 + t3, Math.max(0, remaining)];
            myChart.update();
        }

        function saveProfile() {
            const data = {
                version: CURRENT_VERSION,
                paycheck: document.getElementById('paycheck').value || '',
                freq: document.getElementById('freq').value || '2',
                debts: Array.from(document.querySelectorAll('#debt-body tr')).map(row => ({
                    name: row.querySelector('input[type=text]').value || '',
                    min: row.querySelector('.debt-min-input').value || '0',
                    bal: row.querySelector('.debt-balance-input').value || '0',
                    rate: row.querySelector('.debt-rate-input').value || '0'
                })),
                t0: Array.from(document.querySelectorAll('.tier-0-input')).map(i => i.value || '0'),
                t1: Array.from(document.querySelectorAll('.tier-1-input')).map(i => i.value || '0'),
                t2: Array.from(document.querySelectorAll('.tier-2-input')).map(i => i.value || '0'),
                t3: Array.from(document.querySelectorAll('.tier-3-input')).map(i => i.value || '0')
            };
            localStorage.setItem(CURRENT_VERSION, JSON.stringify(data));
            alert('STRATEGY SECURED');
        }

        function loadProfile() {
            const saved = localStorage.getItem(CURRENT_VERSION);
            if (!saved) { calculateAll(); return; }

            let data;
            try {
                data = JSON.parse(saved);
                if (data.version !== CURRENT_VERSION) throw new Error("Old version");
            } catch (e) { calculateAll(); return; }

            // Clear everything first
            clearAllInputs();

            // Rebuild debts
            if (data.debts && Array.isArray(data.debts)) {
                document.getElementById('debt-body').innerHTML = '';
                data.debts.forEach(debt => {
                    const row = document.createElement('tr');
                    row.className = "border-b border-white/5";
                    row.innerHTML = `
                        <td class="py-4 px-2"><input type="text" value="${debt.name}" class="bg-transparent w-full outline-none text-white text-xs uppercase"></td>
                        <td class="py-4 px-2"><input type="number" value="${debt.min}" oninput="calculateAll()" class="debt-min-input bg-transparent w-full outline-none text-white text-xs"></td>
                        <td class="py-4 px-2"><input type="number" value="${debt.bal}" oninput="calculateAll()" class="debt-balance-input bg-transparent w-full outline-none text-white text-xs"></td>
                        <td class="py-4 px-2"><input type="number" step="0.1" value="${debt.rate}" oninput="calculateAll()" class="debt-rate-input bg-transparent w-full outline-none text-white text-xs"></td>
                        <td class="text-right relative"><button onclick="removeRow(this)" class="hover:text-crimson transition text-lg">×</button>
                            <span class="debt-alert ${parseFloat(debt.rate || 0) >= 25 ? '' : 'hidden'} absolute right-8 top-1/2 -translate-y-1/2 high-interest-alert uppercase">HIGH ALERT</span>
                        </td>`;
                    document.getElementById('debt-body').appendChild(row);
                });
            }

            document.getElementById('paycheck').value = data.paycheck || '';
            document.getElementById('freq').value = data.freq || '2';

            // Dynamically fill ALL inputs in each tier
            document.querySelectorAll('.tier-0-input').forEach((el, i) => el.value = data.t0?.[i] || '');
            document.querySelectorAll('.tier-1-input').forEach((el, i) => el.value = data.t1?.[i] || '');
            document.querySelectorAll('.tier-2-input').forEach((el, i) => el.value = data.t2?.[i] || '');
            document.querySelectorAll('.tier-3-input').forEach((el, i) => el.value = data.t3?.[i] || '');

            calculateAll();
        }

        window.onload = initChart;
    </script>
</body>
</html>
